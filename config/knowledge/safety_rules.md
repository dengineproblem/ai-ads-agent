# Правила безопасности

Эти правила обязательны при работе с рекламными аккаунтами.

---

## Dangerous операции

Следующие операции требуют **подтверждения пользователя**:

### Критические (всегда спрашивать)
- Изменение бюджетов (увеличение/уменьшение)
- Пауза кампаний, adsets, ads
- Создание новых кампаний
- Удаление чего-либо
- Изменение таргетинга

### Средний риск (показать план)
- Возобновление приостановленных объектов
- Дублирование кампаний/adsets
- Изменение bid strategy

### Низкий риск (можно без подтверждения)
- Чтение метрик и статистики
- Формирование отчетов
- Поиск интересов/локаций

---

## Ограничения бюджетов

### Максимальные изменения за раз

| Действие | Лимит | Причина |
|----------|-------|---------|
| Увеличение бюджета | **30%** | Резкое увеличение ломает обучение алгоритма |
| Уменьшение бюджета | **50%** | Слишком резкое снижение может убить adset |

### Абсолютные границы (если не указано в брифе)

| Параметр | Значение |
|----------|----------|
| Минимальный бюджет AdSet | $3/день |
| Максимальный бюджет AdSet | $100/день |
| Бюджет для нового AdSet | $10-20/день |

### Примеры расчета

```
Текущий бюджет: $20
Максимальное увеличение: $20 * 1.30 = $26
Максимальное уменьшение: $20 * 0.50 = $10
```

---

## Временные ограничения

### Создание новых adsets

- **НЕ создавать после 18:00** по часовому поясу аккаунта
- **Причина**: Facebook алгоритмы не успеют оптимизироваться за оставшееся время дня
- **Исключение**: срочные кампании по явному запросу пользователя

### Learning phase

- Новые adsets находятся в learning phase ~7 дней
- **НЕ менять бюджет** пока adset в learning (если нет критических проблем)
- **НЕ менять таргетинг** в learning phase

---

## Минимум данных для решений

### Для изменения бюджета

| Метрика | Минимум |
|---------|---------|
| Impressions | 1000 |
| Конверсии | 3 |
| Дней с данными | 2 |

### Для сегодняшнего дня

| Метрика | Минимум |
|---------|---------|
| Impressions | 300 |
| Spend | $3 |

**Если данных меньше** - не принимать решений, ждать больше данных.

---

## Ad-Eater Detection

Ad-eater - это объект (ad, adset) который тратит бюджет без результата.

### Критерии ad-eater

| Уровень | Критерий | Действие |
|---------|----------|----------|
| **Критический** | CPL > 3x целевого | Немедленная пауза |
| **Высокий** | CPL > 2x целевого + spend > 50% | Снизить бюджет на 50% |
| **Средний** | CPL > 1.5x целевого | Мониторинг, возможно снижение |

### Пример

```
Целевой CPL: $5
Ad-eater уровень:
- Критический: CPL > $15
- Высокий: CPL > $10 и тратит больше половины бюджета
- Средний: CPL > $7.50
```

---

## История действий (action_history)

### Зачем нужна история

История действий за последние 3 дня помогает принимать более умные решения:

1. **Избегать повторных действий** - не снижать бюджет дважды подряд без причины
2. **Учитывать период обучения** - новые adsets не трогать 48 часов
3. **Анализировать паттерны** - 3 снижения за 3 дня → пауза
4. **Избегать колебаний** - не снижать сразу после повышения
5. **Today-компенсация** - хороший сегодня отменяет плохой вчера

### Где хранится

```
.claude/ads-agent/history/
├── 2026-01/
│   ├── 2026-01-17.md
│   ├── 2026-01-18.md
│   └── 2026-01-19.md
└── 2026-02/
    └── ...
```

### Правила применения истории

| Ситуация | Правило | Исключение |
|----------|---------|------------|
| Adset создан < 48ч | Не трогать агрессивно | Critical ad-eater (CPL > 3x) |
| Вчера уже снижали бюджет | Не снижать снова | CPL вырос в 3+ раза |
| 3 снижения за 3 дня | Пауза вместо снижения | — |
| Вчера повышали бюджет | Не снижать сегодня | CPL вырос в 2+ раза |
| Today лучше yesterday | Мониторинг вместо снижения | — |

### Формат записи

```markdown
## HH:MM - {Операция} (skill: {skill_name})

### Действия выполнены:

| # | Тип | Object ID | Object Name | Old Value | New Value | Причина | Статус |
|---|-----|-----------|-------------|-----------|-----------|---------|--------|
| 1 | budget_increase | 123456 | AdSet_Name | $20 | $26 | CPL $2.8, HS +35 | success |
```

### Типы действий для логирования

| Тип | Описание | Пример |
|-----|----------|--------|
| `budget_increase` | Повышение бюджета | $20 → $26 |
| `budget_decrease` | Снижение бюджета | $30 → $21 |
| `pause_ad` | Пауза объявления | active → paused |
| `pause_adset` | Пауза adset | active → paused |
| `resume_ad` | Возобновление | paused → active |
| `resume_adset` | Возобновление | paused → active |
| `create_adset` | Создание adset | - → $15 |
| `create_campaign` | Создание кампании | - |
| `update_targeting` | Изменение таргетинга | - |

### ВАЖНО

- История — это **контекст для умных решений**, НЕ жёсткое ограничение
- При критических ситуациях (CPL 5x target) — действуй немедленно, несмотря на историю
- Всегда логируй выполненные действия для будущих решений

---

## Защита от ошибок

### Перед выполнением проверить

1. **Правильный аккаунт?** - убедись что работаешь с нужным account_id
2. **Правильный объект?** - campaign/adset/ad ID соответствует названию
3. **Лимиты соблюдены?** - изменение в рамках правил
4. **Данных достаточно?** - минимум метрик для решения

### Что делать при ошибке

1. **Немедленно сообщить пользователю**
2. **Попытаться откатить** если возможно (вернуть бюджет, возобновить paused)
3. **Записать в history** что произошло

---

## Чек-лист перед dangerous операцией

- [ ] **История прочитана** за последние 3 дня
- [ ] Прочитан бриф аккаунта
- [ ] Проверены целевые метрики
- [ ] Данных достаточно для решения
- [ ] **Правила истории применены** (5 правил)
- [ ] Изменение в рамках лимитов
- [ ] План показан пользователю
- [ ] Получено подтверждение
- [ ] **Действия залогированы** в history/
